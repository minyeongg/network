Chapter 8. 패킷의 라우팅<br>

# 8.1 개요

- 인터넷은 많은 라우터와 호스트들이 있음<br>
- 유니캐스트 라우팅은 각각 다른 라우팅 알고리즘을 사용하는 여러 단계를 거치는 계층적 라우팅 방식을 사용함<br>
- 라우팅 원리<br>
- 알고리즘<br>
- 계층적 라우팅을 사용하는 유니캐스트 라우팅<br>

## 8.1.1 일반적인 개념

- 유니캐스트 라우팅에서 패킷은 포워딩 테이블을 참조하여 발신지에서 목적지까지 홉 단위로 전달된다.<br>
- 발신지 호스트는 포워딩 테이블이 필요없다.<br>
- 목적지 호스트 역시 포워딩 테이블이 필요없다.<br>
- 라우터만 포워딩 테이블이 필요하다.<br>

## 8.1.2 최소 비용 라우팅

- 인터넷은 가중치 그래프로 모델링 된다.<br>
- 발신지 라우터는 목적지 라우터까지의 모든 가능한 경로 중에 비용의 합이 가장 적은 경로를 선택한다.<br>

### 최소 비용 트리 (최소 신장 트리와 유사)

- 라우터들 사이의 모든 최소 비용 경로를 확인하는 좋은 방법 최소 비용 경로들을 최소 비용 트리로 결합하는 것이다.<br>
- 인터넷의 가중치 그래프 모델에서, 각 노드(라우터)를 루트로 하는 최소 비용트리를 노드의 개수만큼 만들 수 있다.<br>

## 8.2 라우팅 알고리즘

- 라우팅 알고리즘 종류들 사이의 차이점은 최소비용의 정의와 각 노드를 루트로 하는 최소 비용 트리를 반드는 방법이다.<br>
- 일반적인 알고리즘을 먼저 보고, 라우팅 프로토콜이 구현한 알고리즘을 볼 것임.<br>

### 8.2.1 거리-벡터 라우팅

- 최소 비용 트리를 작성하는 방법임
- 제일 처음으로 각 노드가, 인접 노드의 초기 정보를 이용해 자신을 루트로 하는 최소 비용 트리를 만든다. (아직은 불완전한 트리)<br>
- 라우터들은 계속해서 인접 노드에게 자신의 네트워크 정보를 알려준다.<br>
- 거리-벡터 라우팅의 핵심은 벨만-포드 방정식이다.<br>
  - 벨만-포드 방정식은 중간 노드를 통해 발신지 노드 x와 목적지 노드 y 사이의 최소 비용을 찾는 데 사용된다. <br>
  - 발신지 노드~중간 노드 비용, 중간 노드~목적지 노드 비용이 계산에 사용된다.<br>
  - 식: x에서 y사이의 최소 비용은 두 노드 사이의 모든 중간 노드를 거쳤을 때의 각 비용 중 가장 작은 비용이다. <br>
  - 한번 결정된 최소 비용은 새로운 중간노드가 발견되면 또 비교된 후 갱신된다. <br>
- 그렇게 해서 각 노드를 루트로 하는 최소 비용 트리들이 만들어진다. <br>
- 각 최소 비용 트리는 각 노드의 거리 벡터(열벡터)로 나타낼 수 있다. <br>
- 그림 8.5: 초기 단계(가중치 그래프)를 각 노드의 열벡터로 나타낸 그림 <br>
- 그림 8.6: 인접 노드들 모두와 통신하여 각 노드의 거리 벡터를 갱신하는 그림 <br>
- 그림 8.7: 두 노드의 불안정성 <br>
  a. x - A(라우터) - y - B(라우터) : A에서 X까지는 1홉, B에서 X까지는 2홉이다.<br>
  b. x에서 A로의 링크가 끊어졌다. A에서 X까지의 비용은 무한대로 갱신된다. 아직 B의 포워딩 테이블은 업데이트 되지 않았다. <br>
  c. A는 B의 업데이트 되지 않은 포워딩 테이블을 보고 착각해서 홉 수를 3으로 업데이트 한다. 그러면 이제 A에 x쪽으로 가는 패킷이 오면 A는 그 패킷을 B쪽으로 보낸다. B는 자신의 포워딩 테이블을 보고 그 패킷을 다시 A로 보낸다. A는 다시 B로 보낸다. B는 다시 A로 보낸다. 패킷은 따라서 A와 B 사이에서 계속 돌게 된다. <br>
  d. 그러다가 A가 B에게 자신의 홉 수가 3이라는 정보를 알려주면 B는 자신의 홉 수를 4로 갱신한다.<br>
  e. d의 과정을 계속 반복하다보면 A와 B의 홉 수는 둘다 무한이 된다.<br>
  X로 가는 패킷이 들어오면 이제 그 패킷을 버린다. <br>
  -> 이러한 거리-벡터 라우팅의 단점을 해소하기 위한 다양한 방법이 있다. 그건 몰라도 된다. <br>

### 8.2.2 링크 상태 라우팅

- 최소 비용 트리를 작성하는 또 다른 알고리즘이다.<br>
- 링크 = 라우터 간의 연결 = 엣지<br>
- 에지의 비용이 링크의 상태를 결정한다.<br>
- 저비용의링크를 선호한다. <br>
- 링크 상태가 무한대다 = 링크가 존재하지 않거나 깨져있다 <br>
- 그림 8.8: 링크 상태 데이터베이스(LSDB) <br>
  a: 가중치 그래프, b: a를 보고 만든 링크 상태 데이터베이스. 이는 각 노드에서 각 노드로의 거리를 나타낸 행렬이다. 즉 모든 링크 상태의 집합이다. 모든 노드들은 서로 정보 교환 후 완성된 이 "초기" 상태의 LSDB를 각각 가지고 있다.<br>
- 그림 8.9: 각 노드는 모든 노드로부터 링크 상태 정보를 받아서 각자 동일한 "초기"의 링크 상태 데이터베이스를 만든다. <br>
- 이 "초기"의 링크 상태 데이터베이스로부터 최소 비용 트리를 만드는 데 사용되는 알고리즘이 다익스트라 알고리즘이다. <br>
- 다익스트라 알고리즘의 단계:<br>
  1. 자기 자신을 루트 노드로 선정해 루트 노드만 있는 트리로 시작한다. <br>
  2. 아직 트리에 없고 연결된 노드를 선택하여 트리에 추가하고, 루트로부터 트리 내의 모든 노드까지의 비용을 업데이트한다.<br>
     루트로부터 목적지 x까지의 비용 D[x] = min{D[x], D[w] + c[w][x]} (w는 추가 노드)<br>
  3. 모든 노드가 트리에 추가될 때까지 2를 반복한다. <br>
- 그림 8.10: 다익스트라 알고리즘을 사용하여 최소 비용 트리를 만드는 과정 <br>
  -----> 결국에 다익스트라 알고리즘이 중요한건데 이걸 낼거같진 않음... 넘어가자

### 8.2.3 경로 벡터 라우팅

- 거리 벡터 라우팅과 링크 상태 라우팅은 최소 비용 트리를 만드는 것을 목표로 하지만 경로 벡터 라우팅은 아니다. <br>
- 라우터에게 특정한 규칙을 적용시키기 위한 알고리즘이다. <br>
- 예를 들면, 어떤 라우터는 패킷이 통과하지 못하게 하는 것이 있다. <br>
- 각 루트 노드는 최소 비용 트리가 아닌 best spanning 트리를 가진다. <br>
- 발신지 노드에서 라우터에 정책을 적용하는데, 동시에 여러 정책을 적용할 수 있다. <br>
- 경로가 두개 이상인 경우는 정책에 가장 적합한 경로를 선택한다. <br>
- 그림 8.11: 경로 벡터 라우팅에서 각 노드를 루트로 하는 스패팅 트리 <br>
- 그림 8.12: 부팅 시간에 만들어지는 경로 벡터: 각 노드는 인접한 노드로 가는 경로 벡터를 가지고 있다. <br>
- 그림 8.13: 경로 벡터 갱신: 이웃노드와 경로 벡터를 교환해서 경로 벡터를 갱신함 <br>

## 8.3 유니캐스트 라우팅 프로토콜

- 라우팅 정보 프로토콜(Routing Information Protocol): 거리 벡터 알고리즘 기반<br>
- 개방 최단 경로 우선(Open Shortest Path First): 링크 상태 알고리즘 기반<br>
- 경계 게이트웨이 프로토콜(Border Gateway Protocol): 경로 벡터 알고리즘 기반<br>
  ---> 순서로 외우기

### 8.3.1 인터넷 구조

- 유니캐스트 라우팅 프로토콜을 각각 보기 전에 인터넷 구조부터 이해해야 한다.
- 오늘날 인터넷은 다중 백본 구조임. <br>
- 유니캐스트 라우팅은 각각 다른 라우팅 알고리즘을 사용하는 여러 단계를 거치는 계층적 라우팅 방식을 사용한다.<br>
- 각 ISP는 네트워크와 라우터를 제어할 때 자율 시스템(Autonomous System)이다.<br>
- 소형, 중형, 대형 AS가 있다. <br>
- 각 AS에는 자율 번호(ASN)이 부여된다. <br>
- AS 내의 라우팅 프로토콜: (AS는 작은 개념이고 글로벌은 큰 개념인듯??)<br>
  - 인트라(내부) AS 라우팅 프로토콜<br>
  - 인트라 도메인(작은 네트워크) 라우팅 프로토콜<br>
  - IGP(Interior Gateway Protocol)<br>
- 글로벌 라우팅 프로토콜:<br>
  - 인터 AS 라우팅 프로토콜(AS 간의 라우팅 프로토콜)<br>
  - 인터 도메인 라우팅 프로토콜<br>
  - EGP(Exterior Gateway Protocol)<br>

### 8.3.2 라우팅 정보 프로토콜

- 인터넷에서 가장 널리 사용되는 라우팅 프로토콜이다. <br>
- 거리 벡터 라우팅 알고리즘 기반이다. <br>
- 인트라 도메인(AS랑 거의 같은 뜻으로 쓰는듯?) 라우팅 프로토콜이다.
- 그림 8.15: 라우팅 정보 프로토콜에서의 홉 카운트: 거쳐야 하는 라우터가 아닌 네트워크의 수임. <br>
- 그림 8.16: 라우팅 정보 프로토콜에서의 포워딩 테이블: 여기서는 인접한 네트워크로의 홉 수가 1이다.<br>
- 그림 8.17: 라우팅 정보 프로토콜에서는 인접 라우터들끼리 RIP 매시지를 통해 자신의 포워딩 테이블을 공유한다.<br>
- 그림 8.18(1): RIP를 사용하는 AS의 예 - 부팅 후 초기상태<br>
- 그림 8.18(2): RIP를 사용하는 AS의 예 - 인접 라우터들끼리 메시지를 주고받아 각자의 포워딩 테이블을 갱신함<br>

### 8.3.3 개방 최단 경로 우선

- RIP처럼 인트라 도메인(AS랑 거의 같은 뜻으로 쓰는듯?) 라우팅 프로토콜이다. <br>
- 링크 상태 라우팅 알고리즘 기반이다. <br>
- open이라는 뜻은 개방형 프로토콜이라는 뜻이다. 즉 규격이 공개되어 있다. <br>
- 그림 8.19: OSPF에서의 메트릭: 각 라우터에서 목적지까지 가는 비용의 총합<br>
- 그림 8.20: OSPF에서의 포워딩 테이블 <br>
- 그림 8.21: AS에서의 지역(Areas): OSPF는 RIP와 다르게 AS를 지역으로 분할함<br>

### 8.3.4 경계 게이트웨이 프로토콜

- 인터 도메인 라우팅 프로토콜이다. <br>
- 경로 벡터 라우팅 알고리즘 기반이다. <br>
- 그림 8.24: 4개의 AS(도메인이랑 거의 같은 뜻으로 쓰는듯?)를 갖는 인터넷 예 <br>
- 그림 8.25: eBGP(external BGP, AS의 경계 라우터에서 작동하는 프로토콜)의 동작 : 다른 AS와 정보 교환 <br>
- 그림 8.26: iBGP(internal BGP, 모든 라우터에서 작동하는 프로토콜)의 동작 : AS 내의 모든 라우터와 정보 교환<br>
- 그림 8.27~8.28: BGP에는 경로 테이블이 있다. --> 수업에서도 빨리 넘어갔음...<br>

## 8.4 멀티캐스트 라우팅

- 인터넷 통신에서는 유니캐스팅 뿐만 아니라 멀티캐스팅도 쓴다.<br>
- 유니캐스팅, 멀티캐스팅, 브로드 캐스팅의 기본 개념 <br>
- 멀티캐스팅 라우팅의 기본 개념 <br>
- 인터넷에서의 멀티캐스트 라우팅 프로토콜

### 8.4.1 유니캐스팅

- 하나의 발신지와 하나의 목적지<br>
- 발신지 네트워크와 목적지 네트워크가 1대 1<br>
- 데이터그램의 경로에 있는 각 라우터는 하나의 인터페이스로 패킷을 전달한다.<br>
- 그림: 유니캐스팅: 한 발신지에서 보낸 패킷을 라우터에서 하나의 인터페이스로 보내서 하나의 목적지에 전달.

### 8.4.2 멀티캐스팅

- 하나의 발신지와 목적지 그룹<br>
- 1대 다 관계<br>
- 발신지 주소는 유니캐스트 주소이다. <br>
- 목적지 주소는 하나 이상의 목적지 주소로 이루어진 그룹 형태이다. <br>
- 목적지 주소의 그룹에는 멤버가 최소 하나 이상 존재한다.<br>
- 그림: 멀티캐스팅: 한 발신지에서 보낸 패킷이 멤버가 최소 하나이상 존재하는 그룹들로 전달됨<br>
- 그림: 다중 유니캐스팅 vs. 멀티캐스팅: 다중 유니캐스팅에서는 한 목적지 그룹이 같은 패킷을 여러개 받을 수도 있다. <br>

### 8.4.3 거리 벡터 멀티캐스트 라우팅 프로토콜(DVMRP)

- RIP(유니캐스트 라우팅 프로토콜)을 확장한 것<br>
- 발신지 기반 트리 기법을 사용한다. (그룹 내의 노드 개수만큼 트리가 있음. 각각을 루트로 해야 하니까.) <br>
- 멀티캐스트 패킷을 수신할 각 라우터는 먼저 발신지 기반 멀티캐스트 트리를 생성해야 한다. <br>
- 발신지 기반 멀티캐스트 트리 생성 3단계:(일반트리 - 브로드캐스팅 트리 - 멀티캐스팅 트리 순이라고 암기) <br>

1. 역경로 "포워딩"(Reverse Path Forwarding, RPF): 발신지와 라우터 자체 사이의 최적의 "발신지 기반 트리 "생성 <br>
2. 역경로 "브로드캐스팅"(Reverse Path Broadcasting, RPB): 루트인 라우터와 인터넷 상의 모든 네트워크 간에 "브로드캐스트 트리"를 생성한다. <br>
3. 역경로 "멀티캐스팅(Reverse Path Multicasting, RPM): 라우터는 역경로 멀티캐스팅 알고리즘을 사용하여 그룹에 구성원이 없는 네트워크로 끝나는 트리의 일부 분기를 절단하여 멀티캐스트 트리로 만듦. <br>

- 그림: RPF와 RPB: RPF는 다중 유니캐스팅 vs 멀티캐스팅 그림에서의 전자와 같고 RPB는 후자와 같음.<br>
- 그림: RPB와 RPM: RPM에서는 멤버가 없는 네트워크로 연결된 트리 분기를 절단함.<br>

### 8.4.4 멀티캐스트 개방 최단 경로 우선(MOSPF)

- OSPF(유니캐스트 라우팅 프로토콜)를 확장한 것<br>
- 발신지 기반 트리 기법을 사용한다. (그룹 내의 노드 개수만큼 트리가 있음. 각각을 루트로 해야 하니까.) <br>
- 유니캐스트 링크 상태 라우팅 알고리즘으로 운영되는 인터넷은 멀티캐스트 링크 상태 알고리즘을 제공하는 형태로 확장 가능<br>
- 윗줄을 위해서 각 라우터는 어느 인터페이스가 특정 그룹과 이어지는지를 보여주는 데이터베이스가 필요함. <br>
- 그림: MOSPF 트리 형성의 예 --> 넘어가도 될듯?

### 8.4.5 프로토콜 독립 멀티캐스트(PIM)

- 멀티캐스트 동작을 위해 거리 벡터 프로토콜이나 링크 상태 프로토콜이 아닌 (단지?) 유니캐스트 라우팅 프로토콜이 필요한(즉 유니캐스트 라우팅 프로토콜의 포워딩 테이블은 사용한다는 뜻) 일반 프로토콜을 말함.-> 뭔소리고? <br>
- 즉, PIM은 목적지까지의 경로 내의 다음 라우터를 찾기 위해 유니캐스트 라우팅 프로토콜의 포워딩 테이블을 사용해야 하지만 포워딩 테이블이 어떻게 생성되는지(이게 프로토콜이니까 프로토콜 독립임)는 신경쓰지 않는다. <br>
- 두 가지 방식이 있음: <br>
  PIM-DM: PIM Dense(밀집) Mode: 그룹의 액티브 멤버가 많을 때 <br>
  PIM-SM: PIM Sparse(성긴) Mode: 소수 라우터만이 액티브 멤버를 가질 때 <br>

## 8.5 IGMP

- 인터넷의 그룹 멤버십 정보 수집에 사용되는 프로토콜(라우터들이 자신의 네트워크 안에 그룹 멤버가 있는지 없는지를 파악하는 데 사용하는 프로토콜)<br>
- 네트워크 층에 정의된 IP의 보조 프로토콜임<br>
- IGMP 메시지는 IP 패킷에 캡슐화됨 --> 외우기<br>

### 8.5.1 IGMPv3 메시지

- 질의 메시지<br>
- 보고 메시지<br>
- 라우터는 현재 네트워크 내의 모든 호스트에게 주기적으로 질의 메시지를 보내서 그룹 내에 멤버가 있는지를 확인함<br>
- 호스트는 보고 메시지로 응답함

### 8.5.2 멤버십 정보의 전파

- 라우터가 트리의 자신의 레벨에서 호스트들과 다른 라우터들로부터 멤버십 정보를 수집한 후 , 루트 라우터에게 전파함<br>
- 루트 라우터는 이 멤버십 정보를 모아서 멀티캐스트 트리를 만듦 <br>
- 자세히 몰라도 됨

### 8.5.3 캡슐화

- 페이로드 부분에 IGMP 메시지가 들어감 <br>
- IGMP 메시지는 프로토콜 필드값은 2, TTL 필드 값은 1로 설정(TTL은 라우터를 거칠 때마다 하나씩 줄이고 0 이되면 폐기하는 데 1이라는 것은 현재 네트워크 내에서만 전파하는 것) 된 IP 패킷에 캡슐화됨<br>
- 패킷의 목적지 IP 주소는 IGMP 메시지와는 상관이 없고 메시지 유형에 따라 다름<br>
- 
