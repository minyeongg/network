## 7.5 IPv6

### 7.5.1 IPv6 주소

전환 주된 이유: 주소공간 부족<br>
IPv6 주소 길이 : 128비트 = 16 바이트(옥텟) = IPv4 주소 길이의 4배<br>

#### IPv6 주소 표현법

바이너리 표기법<br>
16진 콜론 표기법(Coloned Hexadecimal) ex) FEF6:BA98:7654:3210:ADEF:BBFF:2922:FF00<br>

#### IPv6 주소공간

IPv4 주소(43억 개)의 2^96배<br>

#### IPv6 주소 유형

- 유니캐스트 주소<br>
- 애니캐스트 주소: 단일 주소를 공유하는 컴퓨터 그룹을 정의함. 애니캐스트 주소를 가진 패킷은 가장 접근하기 쉬운 "그룹 내의 한 구성원" 에게만 전달됨<br>
- 멀티캐스트 주소: 애니캐스트에서는 단 하나의 패킷 사본이 그룹 구성원 중 한명에게 전송되지만 멀티캐스팅에서는 각각의 그룹 구성원이 사본을 받는 것임.

#### IPv6 주소공간 할당

- IPv6의 주소공간은 가변길이의 여러 블럭으로 분할하고,
  각 공간은 특수 목적으로 사용<br>
  대부분의 공간은 아직 미할당 -> 미래 사용을 위해 남겨둠<br>
  아래가 할당된 블록들들이다.

- 001로 시작하는 주소, 즉 CIDR 표기법으로 2000::/3인 주소 공간은 Global unicast 주소. 즉 인터넷에 연결된 컴퓨터들에게 유일하게 하나하나 나눠줄 수 있는 주소로 사용함. 전체 공간의 1/8에 해당함.<br>
- 다른 프리픽스 :<br>
  0000 0000으로 시작하는 주소, 즉 CIDR 표기법으로 0000::/8인 주소공간은 특수 주소,<br>
  1111 110으로 시작하는 주소, 즉 CIDR 표기법 상으로 FC00::/7은 Unique local unicast. 즉, 특정 네트워크 안의 사설주소같이 쓸 수 있는 주소.<br>
  1111 1110 10으로 시작하는 주소, 즉 CIDR 표기법 상으로 FE80::/10은 Link-local address. 즉, 조그만 네트워크 내부에서만 사용되는 특수 주소<br>
  1111 1111로 시작하는 주소 즉 CIDR 표기법 상으로 FF00::/8은 Multicast address. 즉, 여러 컴퓨터에게 동시에 메시지를 보낼 때 사용하는 주소<br>

- 글로벌 유니캐스트 주소는 128비트를 반으로 나눠서 앞부분은
  할당하는 주소, 뒷부분은 컴퓨터 자체적으로 만들어지는 주소(Interface identifier)
  앞부분의 할당하는 주소도 반으로 나눠서<br>
  Global routing prefix가 네트워크 주소를, (큰 네트워크)
  Subnet Identifier가 서브넷 주소를 나타냄. (작은 네트워크)<br>

- 예제 7.1<br>
  나머지 16비트를 각 서브넷 마다 0001, 0002, 0003으로 할당.<br>
  첫 번째와 두 번째 서브넷의 블록에 대한 CIDR 표기는 각각<br>
  2000:1456:2474:0000/64, 2000:1456:2474:0001/64<br>

  - EUI-64 매핑(Extended Unique Identifier-64)<br>
    EUI-64는 MAC 주소를 64비트로 확장한 것.<br>
    7번째 비트인 0을 1로 바꿔서 EUI-64를 interface identifier로 바꿈.<br>
    즉 EUI-64 형식의 identifier가 됨.<br>
    7번째 비트를 universal/local bit라고 부름.<br>
    universal : 전 세계에서 유일한 주소<br>
    7번째가 1이라는 것은 universal bit이라는 것.<br>

- Ethernet MAC 주소의 EUI-64 매핑<br>
  보통 컴퓨터들의 layer2 주소가 Ethernet MAC 주소임.<br>
  이는 48비트임. 이를 가지고 그 컴퓨터의 UID(64비트)를 만들어야 하므로 16비트를 채워야 함.<br>
  그래서 48비트를 반으로 잘라서 중간에 FFFE라는 16비트(16진수 한 자리는 4비트 이므로)를 넣음.<br>
  만들어진 주소는 EUI-64 형식의 주소가 됨.<br>

- 특수 주소<br>
  unspecified : 0000::/128 즉 모든 비트가 0임. 아직 할당 안된 주소.<br>
  loopback : 0000::1/128. 0000:0000:0000:0000:0000:0000:0000:0001/128. 이 주소로 보내면 데이터가 자기 자신에게 돌아오는 주소<br>
  ipv4에서도 쓰이고 ipv6에서도 쓰이는 주소 두가지<br>
  compatible : IPv6 컴퓨터가 IPv4 전용 라우터를 통해서 IPv6 컴퓨터에 패킷을 전송할 때 사용함. 전부 0 + IPv4 주소. 0000::/96<br>
  mapped : IPv6 컴퓨터가 IPv4 컴퓨터에게 패킷 전송할 때 사용함. 전부 0 + 1이 16비트 개 + IPv4 주소. 0000::FFFF/96<br>

- unique local unicast block<br> -> ppt 142p
  사설네트워크<br>
  Unique local: FC00::/7. 뒤쪽 64비트는 인터페이스 ID. 네트워크 prefix는 서브넷 ID 혹은 랜덤넘버를 사용함.<br>
  Link local : 작은 네트워크 안에서만 사용할 수 있는 주소. 1111111010 + 전부 0 + 인터페이스 ID. FE80::/10<br>
  Multicast: F000::/8. 플래그+scope비트+Group ID(112비트)<br>

#### IPv6 주소 자동설정 (auto configuration)

IPv6의 흥미로운 특징으로,<br>
IPv4에서는 호스트 주소를 수동설정 혹은 DHCP(동적 호스트 구성 프로토콜)에 의해 자동설정함.<br>
IPv6에서도 DHCP를 주소 할당에 사용할 수 있지만,<br>
IPv6에서는 호스트가 스스로 주소를 설정할 수 있음.

### Renumbering

지금까지 유니캐스트 주소를 잘 썼는데 갑자기
네트워크 주소가 바뀌면<br>
라우터가 바뀐 주소를 주기적으로 알려줌.<br>
호스트도 바뀐 주소를 받아서 앞부분의 prefix는 자동적으로 바꾸고
뒷부분은 그대로 씀.<br>
이를 renumbering이라고 함.<br>
-> 서비스 제공자를 변경하는 경우에, 인터페이스 ID는 동일하고,
네트워크 프리픽스와 서브넷 ID만 변경하면 됨.<br>
네트워크 프리픽스와 서브넷 ID는 라우터가 주기적으로 메시지를 통하여 알리고, 각 호스트는 자신의 주소를 이 값으로 변경함.

### 7.5.2 IPv6 프로토콜

#### IPv4에 비해 바뀐 내용

- 더 좋은 헤더 포맷<br>
- 새로운 옵션<br>
- 확장 허용<br>
- 자원 할당 지원<br>
- 더 좋은 보안 지원

#### IPv6 패킷 포맷

- 40바이트 기본 헤더<br>
- 페이로드: 확장 헤더(Optional) + 상위계층데이터. 페이로드는 최대 65,535 바이트까지 가능<br>
- IPv6 데이터그램 : 40바이트 기본 헤더 + 최대 65, 535바이트의 페이로드<br>
  기본 헤더 구조 : 버전(4비트) + 트래픽 클래스(8비트) + 플로우 레이블(20비트) + 페이로드 길이(16비트) + 다음 헤더(8비트) (확장 헤더가 올 경우 어떤 헤더가 오는지) + Hop limit(8비트) (이 패킷을 최대 몇 홉까지 보낼 수 있는지) + 소스 주소(128비트) + 목적지 주소(128비트)<br>
- 다음헤더 필드의 코드 값이<br>
  TCP/UDP이면 상위계층에서 내려온 페이로드라는 뜻임 <br>
  02: ICMPv6 이면 같은 계층에서 온 다른 프로토콜의 메시지라는 뜻임 (페이로드)<br>
  나머지 값들은 옵션(확장헤더)을 나타냄. <br>
  예를 들어 값이 00이면 홉바이홉 확장헤더<br>
  06: TCP 17: UDP 이면 확장헤더가 아닌 진짜 페이로드(상위계층에서 온 데이터)

#### 확장 헤더

- 6가지 확장 헤더 -> IPv4에서는 헤더 내의 옵션이었음<br>

1. 00: Hop-by-Hop Option : 라우터를 거칠 때마다 처리하게 될 내용<br>
2. 43: source routing : 라우팅을 하는 특수한 방식<br>
3. 44: Fragmentation : 첫번째 단편화인지 중간인지 마지막인지 알려줌<br>
4. 51: Authentication : 보안<br>
5. 50: encrypted security payload : 보안<br>
6. 60: destination option : 목적지에 알려줄 내용

### 7.5.3 ICMPv6 프로토콜

- ICMPv6는 ICMPv4 보다 복잡. ICMPv4 + ARP(인접 호스트의 MAC 주소를 얻는 프로토콜), IGMP(그룹 정보를 얻는 프로토콜) 기능 흡수함<br>
- 새로운 메시지들이 추가된 형태임<br><br>

버전 4에서의 네트워크 층 : IPv4 패킷 + ARP + IGMP + ICMP (에러 리포팅 프로토콜)<br>
버전 6에서의 네트워크 층 : IPv6 패킷 + ICMPv6(ARP, IGMP 등의 기능을 모두 포함하는 프로토콜) 만 사용됨<br><br>

- ICMPv6 메시지 범주<br>
  에러 메시지, 정보 메시지, neighbor discovery 메시지 (ARP 보완, ND 프로토콜이라고 따로 분류하기도 함.), Group membership 메시지(그룹 정보를 찾음, MLD 프로토콜이라고 따로 분류하기도 함.)

##### 에러 보고 메시지

- 보고되는 에러 종류 4가지 :<br>
  목적지 도달 불가, 패킷이 너무 큼, 시간 초과(TTL), 헤더 파라미터 오류<br>
  - source-quenched(발신지 억제) 메시지는 제외됨 : IPV4에서는 혼잡 제어 용도로 사용되었었는데 IPV6에서는 헤더의 다른 필드(흐름 레이블 필드)를 활용하여 혼잡을 제어함

##### 정보 메시지

- 두 장치들이 서로 통신할 수 있는지 검사함<br>
- echo request 메시지: 호스트나 라우터가 다른 호스트에게 전송함<br>
- echo reply 메시지: 수신 호스트나 라우터가 으압함<br>
  ping이라는 커맨드 : 소스에서 목적지까지 데이터가 갔다오는 루트가 잘 되어있고 목적지가 잘 살아있는지를 확인하는 것.<br>
  인터넷에서 통신 가능 상태 체크

##### 이웃- 발견(Neighbor Discovery) 메시지 ---> 이부분 강의 다시 듣기

내 주변에 목적지가 있는가, 해당 목적지의 주소는 무엇인가를 찾음<br>
내부적으로 2개의 새로운 프로토콜 지원 :<br>

- 이웃 발견 프로토콜 (NDP)<br>
- 역 이웃 발견 프로토콜 (INDP)<br>
- 이웃 발견 메시지: <br>
- 라우터 요청 메시지<br>
- 라우터 광고 메시지<br>
- 이웃 요청 메시지<br>
- 이웃 광고 메시지<br>
- 재지정 메시지<br>
- 역 이웃 요청 메시지<br>
- 역 이웃 광고 메시지<br>

###### Group Membership 메시지

해당 네트워크 안에 그룹 멤버가 있는지를 라우터가 찾아야하는데 그때 사용하는 메시지<br>
IPv4에서는 IGMPv3 프로토콜이 그룹 통신 관리(멀티캐스트 전달 관리)를 다루었음<br>
IPv6에서는 멀티캐스트 청취 전달 MLD(Multicast Listner Delivery) 프로토콜이 그룹 통신 관리를 다룸<br>
MLDv1: IGMPv2의 IPv6 버전<br>
MLDv2: IGMPv3의 IPv6 버전<br>
MLDv2의 메시지 유형:<br>

- 멤버십 질의 메시지 : 라우터가 요청하는 메시지<br>
- 멤버십 보고 메시지 : 호스트가 응답하는 메시지<br>

## 7.6 IPv6으로의 전환

지금도 같이 사용되고 있지만 차후에는 완전히 넘어가야함.<br>
그 전까지는 공존을 할 것.<br>
즉 전환은 두 시스템 사이에 어떠한 문제도 발생하지 않도록 매끄럽게 진행되어야함.<br>

### 3가지 전환 전략

- 듀얼 스택 :<br>
  네트워크 층에서 IPv4와 IPv6를 동시에 사용하는 방법 <br>
- 터널링 :<br>
  두 end user가 IPv6 호스트이고 그 사이에 IPv4 지역이 있다면 그 부분에서는 버전 6 패킷에 버전 4 헤더를 씌워서 전송 -> 터널이 생성되는 것임.<br>
- 헤더 변환 : <br>
  헤더를 변환 하는 것. 라우터 기준 좌에서 버전 6 헤더이면 우에서는 버전 4 헤더로 변환해서 전송하는 것. (좌측 호스트가 IPv6, 우측 호스트가 IPv4인 경우)

### IP 주소의 사용

전환 완료시 IPv4 주소는 없어질 것<br>
DNS 서버가 중요한 역할을 하게 됨.<br>
